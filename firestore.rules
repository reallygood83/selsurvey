rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // ê°œë°œ ë‹¨ê³„: ëª¨ë“  ì¸ì¦ëœ ì‚¬ìš©ìì—ê²Œ ì½ê¸°/ì“°ê¸° í—ˆìš©
    // í”„ë¡œë•ì…˜ ë°°í¬ ì‹œ ì´ ê·œì¹™ì„ ìˆ˜ì •í•´ì•¼ í•©ë‹ˆë‹¤!
    
    // ì‚¬ìš©ì í”„ë¡œí•„ - ì¸ì¦ëœ ì‚¬ìš©ìê°€ ìì‹ ì˜ ë°ì´í„° ì ‘ê·¼ (ìµœìš°ì„  ê·œì¹™)
    match /users/{userId} {
      // ğŸ” ë³´ì•ˆ ê°•í™”: ìì‹ ì˜ í”„ë¡œí•„ë§Œ ì½ê¸°/ì“°ê¸° ê°€ëŠ¥
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // ğŸ”’ ì¶”ê°€ ê²€ì¦: encryptedGeminiApiKey í•„ë“œëŠ” ë³¸ì¸ë§Œ ìˆ˜ì • ê°€ëŠ¥
      allow update: if request.auth != null &&
                       request.auth.uid == userId &&
                       // API í‚¤ í•„ë“œê°€ ë³€ê²½ë˜ëŠ” ê²½ìš° ì¶”ê°€ ê²€ì¦
                       (!request.resource.data.keys().hasAny(['encryptedGeminiApiKey']) ||
                        request.auth.uid == userId);
    }
    
    // ê°œë°œ í™˜ê²½ìš©: ë‚˜ë¨¸ì§€ ëª¨ë“  ì»¬ë ‰ì…˜ì— ëŒ€í•œ ì ‘ê·¼ í—ˆìš©
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
    
    // ë°˜ ì •ë³´ - êµì‚¬ëŠ” ìì‹ ì˜ ë°˜ë§Œ, í•™ìƒì€ ì½ê¸°ë§Œ
    match /classes/{classId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.teacherId;
      allow update: if request.auth != null && 
        (resource == null || resource.data.teacherId == request.auth.uid);
      allow delete: if request.auth != null && 
        (resource == null || resource.data.teacherId == request.auth.uid);
    }
    
    // í•™ìƒ í”„ë¡œí•„ - êµì‚¬ëŠ” ìì‹ ì˜ ë°˜ í•™ìƒë§Œ, í•™ìƒì€ ìì‹ ë§Œ
    match /students/{studentId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && (
        // í•™ìƒì´ ìì‹ ì˜ í”„ë¡œí•„ì„ ìƒì„±í•˜ëŠ” ê²½ìš°
        request.resource.data.userId == request.auth.uid ||
        // êµì‚¬ê°€ í•™ìƒ í”„ë¡œí•„ì„ ìƒì„±í•˜ëŠ” ê²½ìš°  
        request.resource.data.teacherId == request.auth.uid
      );
      allow update: if request.auth != null && (
        resource == null ||
        // í•™ìƒì´ ìì‹ ì˜ í”„ë¡œí•„ì„ ìˆ˜ì •í•˜ëŠ” ê²½ìš°
        resource.data.userId == request.auth.uid ||
        // êµì‚¬ê°€ ìì‹ ì˜ ë°˜ í•™ìƒ í”„ë¡œí•„ì„ ìˆ˜ì •í•˜ëŠ” ê²½ìš°
        resource.data.teacherId == request.auth.uid
      );
      allow delete: if request.auth != null && (
        resource == null ||
        resource.data.teacherId == request.auth.uid
      );
    }
    
    // ì„¤ë¬¸ ì‘ë‹µ - êµì‚¬ëŠ” ìì‹ ì˜ ë°˜ ì‘ë‹µë§Œ, í•™ìƒì€ ìì‹ ì˜ ì‘ë‹µë§Œ
    match /surveyResponses/{responseId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null;
      allow delete: if request.auth != null;
    }
    
    // SEL ë¶„ì„ ê²°ê³¼ - êµì‚¬ì™€ í•´ë‹¹ í•™ìƒë§Œ
    match /selAnalyses/{analysisId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null;
      allow delete: if request.auth != null;
    }
    
    // ì„¤ë¬¸ - êµì‚¬ëŠ” ìì‹ ì˜ ì„¤ë¬¸ë§Œ, í•™ìƒì€ ìì‹ ì˜ ë°˜ ì„¤ë¬¸ë§Œ
    match /surveys/{surveyId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid != null;
      allow update: if request.auth != null && (
        resource.data.teacherId == request.auth.uid
      );
      allow delete: if request.auth != null && (
        resource.data.teacherId == request.auth.uid
      );
    }
    
    // ì„¤ë¬¸ ì§ˆë¬¸ - êµì‚¬ëŠ” ìì‹ ì˜ ì„¤ë¬¸ ì§ˆë¬¸ë§Œ
    match /surveyQuestions/{questionId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.teacherId;
      allow update: if request.auth != null && 
        (resource == null || resource.data.teacherId == request.auth.uid);
      allow delete: if request.auth != null && 
        (resource == null || resource.data.teacherId == request.auth.uid);
    }
    
    // ì¼ì¼ ê¸°ë¶„ - êµì‚¬ëŠ” ìì‹ ì˜ ë°˜ í•™ìƒë§Œ, í•™ìƒì€ ìì‹ ë§Œ
    match /dailyMoods/{moodId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null;
      allow delete: if request.auth != null;
    }
    
    // ê°œë°œ ë‹¨ê³„ì—ì„œë§Œ: í…ŒìŠ¤íŠ¸ ì»¬ë ‰ì…˜ì— ëŒ€í•œ ì „ì²´ ì ‘ê·¼
    match /test/{document=**} {
      allow read, write: if true; // ê°œë°œìš© - í”„ë¡œë•ì…˜ì—ì„œ ì œê±°!
    }
  }
}